{"version":3,"file":"client-connection-worker.js","names":["socket","serverInfo","reconnectTimeout","queue","self","onmessage","event","_event$data","data","type","server","connectToServer","readyState","WebSocket","OPEN","send","push","close","clearTimeout","protocol","host","location","hostname","prefix","baseURL","postMessage","Date","now","start","SockJS","timeout","err","message","wsURL","replace","err2","onopen","_i2","_queue2","length","_socket","msg","e","raw","slice","startsWith","arr","JSON","parse","_i4","onclose","onerror","_socket2"],"sources":["../src/client-connection-worker.ts"],"sourcesContent":["declare const SockJS: any;\nimport type { ServerInfo } from \"./client-main\";\n\nlet socket: WebSocket | null = null;\nlet serverInfo: ServerInfo;\nlet reconnectTimeout: ReturnType<typeof setTimeout> | null = null;\nlet queue: string[] = [];\n\nself.onmessage = (event: MessageEvent) => {\n\tconst { type, server, data } = event.data;\n\tif (type === 'connect') {\n\t\tserverInfo = server;\n\t\tconnectToServer();\n\t} else if (type === 'send') {\n\t\tif (socket && socket.readyState === WebSocket.OPEN) {\n\t\t\tsocket.send(data);\n\t\t} else {\n\t\t\tqueue.push(data);\n\t\t}\n\t} else if (type === 'disconnect') {\n\t\tif (socket) socket.close();\n\t\tif (reconnectTimeout) clearTimeout(reconnectTimeout);\n\t\tsocket = null;\n\t}\n};\n\nfunction connectToServer() {\n\t// Use SockJS endpoint first; fallback to raw WebSocket /websocket\n\tconst protocol = (serverInfo.protocol || 'https') as 'http' | 'https';\n\tconst host = serverInfo.host || self.location.hostname;\n\tconst prefix = serverInfo.prefix || '/showdown';\n\tconst baseURL = `${protocol}://${host}${prefix}`;\n\tpostMessage({ type: 'debug', data: '[worker] baseURL ' + baseURL + ' t=' + Date.now() });\n\n\ttry {\n\t\tconst start = Date.now();\n\t\t// SockJS constructor may throw synchronously if not available/blocked\n\t\tsocket = new SockJS(baseURL, [], { timeout: 5 * 60 * 1000 });\n\t\tpostMessage({ type: 'debug', data: '[worker] SockJS created in ' + (Date.now()-start) + 'ms' });\n\t} catch (err) {\n\t\tpostMessage({ type: 'debug', data: '[worker] SockJS failed ' + (err as any).message });\n\t\ttry {\n\t\t\tconst wsURL = baseURL.replace('http', 'ws') + '/websocket';\n\t\t\tpostMessage({ type: 'debug', data: '[worker] attempting WS fallback ' + wsURL });\n\t\t\tsocket = new WebSocket(wsURL);\n\t\t} catch (err2) {\n\t\t\tpostMessage({ type: 'error', data: 'Failed to create socket: ' + (err2 as any).message });\n\t\t\treturn;\n\t\t}\n\t}\n\n\tif (!socket) {\n\t\tpostMessage({ type: 'error', data: 'No socket created' });\n\t\treturn;\n\t}\n\n\tsocket.onopen = () => {\n\t\tpostMessage({ type: 'debug', data: '[worker] onopen t=' + Date.now() });\n\t\tpostMessage({ type: 'connected' });\n\t\tfor (const msg of queue) socket?.send(msg);\n\t\tqueue = [];\n\t};\n\n\tsocket.onmessage = (e: MessageEvent) => {\n\t\tconst raw = '' + (e.data as any);\n\t\t// only sample some frames for debug to avoid noise\n\t\tif (typeof raw === 'string' && raw.length < 200) {\n\t\t\tpostMessage({ type: 'debug', data: '[worker] frame sample ' + raw.slice(0,80) });\n\t\t}\n\t\tif (typeof raw === 'string' && raw.startsWith('a[')) {\n\t\t\ttry {\n\t\t\t\tconst arr: string[] = JSON.parse(raw.slice(1));\n\t\t\t\tfor (const msg of arr) postMessage({ type: 'message', data: msg });\n\t\t\t\treturn;\n\t\t\t} catch (e) {\n\t\t\t\tpostMessage({ type: 'debug', data: '[worker] failed to parse SockJS frame' });\n\t\t\t}\n\t\t}\n\t\tpostMessage({ type: 'message', data: raw });\n\t};\n\n\tsocket.onclose = () => {\n\t\tpostMessage({ type: 'debug', data: '[worker] onclose t=' + Date.now() });\n\t\tpostMessage({ type: 'disconnected' });\n\t};\n\n\tsocket.onerror = (err: Event) => {\n\t\tpostMessage({ type: 'error', data: (err as any).message || '' });\n\t\tpostMessage({ type: 'debug', data: '[worker] onerror t=' + Date.now() });\n\t\tsocket?.close();\n\t};\n}\n"],"mappings":"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","ignoreList":[]}