{"version":3,"file":"client-connection-worker.js","names":["socket","serverInfo","reconnectTimeout","queue","self","onmessage","event","_event$data","data","type","server","connectToServer","readyState","WebSocket","OPEN","send","push","close","clearTimeout","prefix","host","protocol","baseURL","postMessage","Date","now","start","SockJS","timeout","err","message","wsURL","replace","err2","onopen","_i2","_queue2","length","_socket","msg","e","slice","onclose","onerror","_socket2"],"sources":["../src/client-connection-worker.ts"],"sourcesContent":["declare const SockJS: any;\nimport type { ServerInfo } from \"./client-main\";\n\nlet socket: WebSocket | null = null;\nlet serverInfo: ServerInfo;\nlet reconnectTimeout: ReturnType<typeof setTimeout> | null = null;\nlet queue: string[] = [];\n\nself.onmessage = (event: MessageEvent) => {\n\tconst { type, server, data } = event.data;\n\tif (type === 'connect') {\n\t\tserverInfo = server;\n\t\tconnectToServer();\n\t} else if (type === 'send') {\n\t\tif (socket && socket.readyState === WebSocket.OPEN) {\n\t\t\tsocket.send(data);\n\t\t} else {\n\t\t\tqueue.push(data);\n\t\t}\n\t} else if (type === 'disconnect') {\n\t\tif (socket) socket.close();\n\t\tif (reconnectTimeout) clearTimeout(reconnectTimeout);\n\t\tsocket = null;\n\t}\n};\n\nfunction connectToServer() {\n\t// Use SockJS endpoint first; fallback to raw WebSocket /websocket\n\tconst prefix = '/showdown';\n\tconst host = 'server.pokemondnd.xyz';\n\tconst protocol = 'https';\n\tconst baseURL = `${protocol}://${host}${prefix}`;\n\tpostMessage({ type: 'debug', data: '[worker] baseURL ' + baseURL + ' t=' + Date.now() });\n\n\ttry {\n\t\tconst start = Date.now();\n\t\t// SockJS constructor may throw synchronously if not available/blocked\n\t\tsocket = new SockJS(baseURL, [], { timeout: 5 * 60 * 1000 });\n\t\tpostMessage({ type: 'debug', data: '[worker] SockJS created in ' + (Date.now()-start) + 'ms' });\n\t} catch (err) {\n\t\tpostMessage({ type: 'debug', data: '[worker] SockJS failed ' + (err as any).message });\n\t\ttry {\n\t\t\tconst wsURL = baseURL.replace('http', 'ws') + '/websocket';\n\t\t\tpostMessage({ type: 'debug', data: '[worker] attempting WS fallback ' + wsURL });\n\t\t\tsocket = new WebSocket(wsURL);\n\t\t} catch (err2) {\n\t\t\tpostMessage({ type: 'error', data: 'Failed to create socket: ' + (err2 as any).message });\n\t\t\treturn;\n\t\t}\n\t}\n\n\tif (!socket) {\n\t\tpostMessage({ type: 'error', data: 'No socket created' });\n\t\treturn;\n\t}\n\n\tsocket.onopen = () => {\n\t\tpostMessage({ type: 'debug', data: '[worker] onopen t=' + Date.now() });\n\t\tpostMessage({ type: 'connected' });\n\t\tfor (const msg of queue) socket?.send(msg);\n\t\tqueue = [];\n\t};\n\n\tsocket.onmessage = (e: MessageEvent) => {\n\t\t// only sample some frames for debug to avoid noise\n\t\tif (typeof e.data === 'string' && e.data.length < 200) {\n\t\t\tpostMessage({ type: 'debug', data: '[worker] frame sample ' + e.data.slice(0,80) });\n\t\t}\n\t\tpostMessage({ type: 'message', data: e.data });\n\t};\n\n\tsocket.onclose = () => {\n\t\tpostMessage({ type: 'debug', data: '[worker] onclose t=' + Date.now() });\n\t\tpostMessage({ type: 'disconnected' });\n\t};\n\n\tsocket.onerror = (err: Event) => {\n\t\tpostMessage({ type: 'error', data: (err as any).message || '' });\n\t\tpostMessage({ type: 'debug', data: '[worker] onerror t=' + Date.now() });\n\t\tsocket?.close();\n\t};\n}\n"],"mappings":"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","ignoreList":[]}