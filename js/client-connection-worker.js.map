{"version":3,"file":"client-connection-worker.js","names":["socket","serverInfo","reconnectTimeout","queue","self","onmessage","event","_event$data","data","type","server","connectToServer","readyState","WebSocket","OPEN","send","push","close","clearTimeout","prefix","host","protocol","baseURL","SockJS","timeout","err","replace","err2","postMessage","message","onopen","_i2","_queue2","length","_socket","msg","e","onclose","onerror","_socket2"],"sources":["../src/client-connection-worker.ts"],"sourcesContent":["declare const SockJS: any;\nimport type { ServerInfo } from \"./client-main\";\n\nlet socket: WebSocket | null = null;\nlet serverInfo: ServerInfo;\nlet reconnectTimeout: ReturnType<typeof setTimeout> | null = null;\nlet queue: string[] = [];\n\nself.onmessage = (event: MessageEvent) => {\n\tconst { type, server, data } = event.data;\n\tif (type === 'connect') {\n\t\tserverInfo = server;\n\t\tconnectToServer();\n\t} else if (type === 'send') {\n\t\tif (socket && socket.readyState === WebSocket.OPEN) {\n\t\t\tsocket.send(data);\n\t\t} else {\n\t\t\tqueue.push(data);\n\t\t}\n\t} else if (type === 'disconnect') {\n\t\tif (socket) socket.close();\n\t\tif (reconnectTimeout) clearTimeout(reconnectTimeout);\n\t\tsocket = null;\n\t}\n};\n\nfunction connectToServer() {\n\t// Use SockJS endpoint first; fallback to raw WebSocket /websocket\n\tconst prefix = '/showdown';\n\tconst host = 'server.pokemondnd.xyz';\n\tconst protocol = 'https';\n\tconst baseURL = `${protocol}://${host}${prefix}`;\n\n\ttry {\n\t\t// SockJS constructor may throw synchronously if not available/blocked\n\t\tsocket = new SockJS(baseURL, [], { timeout: 5 * 60 * 1000 });\n\t} catch (err) {\n\t\ttry {\n\t\t\tsocket = new WebSocket(baseURL.replace('http', 'ws') + '/websocket');\n\t\t} catch (err2) {\n\t\t\tpostMessage({ type: 'error', data: 'Failed to create socket: ' + (err2 as any).message });\n\t\t\treturn;\n\t\t}\n\t}\n\n\tif (!socket) {\n\t\tpostMessage({ type: 'error', data: 'No socket created' });\n\t\treturn;\n\t}\n\n\tsocket.onopen = () => {\n\t\tpostMessage({ type: 'connected' });\n\t\tfor (const msg of queue) socket?.send(msg);\n\t\tqueue = [];\n\t};\n\n\tsocket.onmessage = (e: MessageEvent) => {\n\t\tpostMessage({ type: 'message', data: e.data });\n\t};\n\n\tsocket.onclose = () => {\n\t\tpostMessage({ type: 'disconnected' });\n\t};\n\n\tsocket.onerror = (err: Event) => {\n\t\tpostMessage({ type: 'error', data: (err as any).message || '' });\n\t\tsocket?.close();\n\t};\n}\n"],"mappings":"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","ignoreList":[]}